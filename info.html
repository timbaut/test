<!doctype html>
<html lang="de">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OK</title><meta name="robots" content="noindex,nofollow"></head>
<body>
<script>
const ENDPOINT_URL = "https://bespoke-marigold-09826a.netlify.app/.netlify/functions/collect";
const REF = new URLSearchParams(location.search).get("ref") || null;

function tzOffset(){ const m=new Date(), off=-m.getTimezoneOffset(), s=off>=0?"+":"-"; const h=String(Math.floor(Math.abs(off)/60)).padStart(2,"0"); const mn=String(Math.abs(off)%60).padStart(2,"0"); return `${s}${h}:${mn}`; }
function detectOS(ua){ ua=(ua||"").toLowerCase(); if(/windows nt/.test(ua))return"Windows"; if(/mac os x/.test(ua))return"macOS"; if(/android/.test(ua))return"Android"; if(/iphone|ipad|ipod|ios/.test(ua))return"iOS/iPadOS"; if(/linux/.test(ua))return"Linux"; return"Unbekannt"; }

function collectExtended(){
  const nav=navigator;
  let glInfo=null;
  try{
    const canvas=document.createElement("canvas");
    const gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");
    if (gl){
      const dbg=gl.getExtension("WEBGL_debug_renderer_info");
      if (dbg){ glInfo={ vendor: gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL), renderer: gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) }; }
    }
  }catch(e){}
  return {
    ref: REF,
    timestamp_iso: new Date().toISOString(),
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    tz_offset: tzOffset(),
    language: nav.language,
    languages: nav.languages,
    doNotTrack: nav.doNotTrack || (window.doNotTrack ?? null),
    cookiesEnabled: nav.cookieEnabled,
    platform: nav.platform,
    userAgent: nav.userAgent,
    os: detectOS(nav.userAgent),
    browser: (function(){ const ua=(nav.userAgent||"").toLowerCase();
      if(ua.includes("edg/"))return"Edge"; if(ua.includes("chrome/")&&!ua.includes("edg/")&&!ua.includes("opr/"))return"Chrome";
      if(ua.includes("safari/")&&!ua.includes("chrome/"))return"Safari"; if(ua.includes("firefox/"))return"Firefox"; if(ua.includes("opr/"))return"Opera"; return"Unbekannt"; })(),
    screen:{ w:screen.width, h:screen.height, pixelRatio:window.devicePixelRatio||1, colorDepth:screen.colorDepth },
    viewport:{ w:window.innerWidth, h:window.innerHeight },
    hardware:{ cores:navigator.hardwareConcurrency??null, ramGB:navigator.deviceMemory??null, maxTouch:navigator.maxTouchPoints??0 },
    storage:{ local: !!window.localStorage, session: !!window.sessionStorage },
    connection: navigator.connection ? { type:navigator.connection.effectiveType, downlink:navigator.connection.downlink } : null,
    gl: glInfo,
    local_time: new Date().toString(),
    page:{ href: location.href, referrer: document.referrer },
    event_id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())  // hilfreich f√ºrs Debuggen/De-Dup
  };
}

async function run(){
  try{
    const payload = collectExtended();
    const blob = new Blob([JSON.stringify(payload)], {type:"text/plain;charset=UTF-8"});
    const ok = navigator.sendBeacon(ENDPOINT_URL, blob);
    if (!ok) {
      await fetch(ENDPOINT_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload), keepalive:true });
    }
  }catch(e){}
}
document.addEventListener("DOMContentLoaded", run);
</script>
</body>
</html>
